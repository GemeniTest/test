#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Default number of threads
DEFAULT_THREADS=5

# Banner
echo -e "${BLUE}"
echo "=========================================================="
echo "   MULTI-DOMAIN PASSIVE SUBDOMAIN ENUMERATION TOOLKIT"
echo "   WITH API KEY CONFIGURATION & MULTI-THREADING"
echo "=========================================================="
echo -e "${NC}"

# Function to display usage
show_usage() {
    echo -e "${YELLOW}Usage: $0 [OPTIONS] <domains_file>${NC}"
    echo ""
    echo -e "${CYAN}OPTIONS:${NC}"
    echo -e "  -t, --threads   Number of domains to process in parallel (default: ${DEFAULT_THREADS})"
    echo -e "  --setup-apis    Setup API keys configuration"
    echo -e "  --check-apis    Check current API key configuration"
    echo -e "  --help         Show this help message"
    echo ""
    echo -e "${CYAN}EXAMPLES:${NC}"
    echo -e "  $0 domains.txt                    # Run with ${DEFAULT_THREADS} threads"
    echo -e "  $0 -t 10 domains.txt              # Run with 10 threads"
    echo -e "  $0 --threads 15 domains.txt       # Run with 15 threads"
    echo -e "  $0 --setup-apis                   # Setup API keys"
    echo -e "  $0 --check-apis                   # Check API status"
    echo ""
    echo -e "${CYAN}DOMAINS FILE FORMAT:${NC}"
    echo -e "  example.com"
    echo -e "  *.github.com      # Wildcards automatically cleaned"
    echo -e "  google.com"
    echo -e "  # This is a comment - ignored"
    echo ""
    echo -e "${CYAN}FEATURES:${NC}"
    echo -e "  â€¢ Multi-threaded domain processing (process multiple domains simultaneously)"
    echo -e "  â€¢ Per-tool subdomain count for each domain"
    echo -e "  â€¢ API key support for enhanced results"
    echo -e "  â€¢ Usage summary and statistics"
    echo ""
    echo -e "${CYAN}SUPPORTED TOOLS:${NC}"
    echo -e "  â€¢ Subfinder (with API support)"
    echo -e "  â€¢ Assetfinder"
    echo -e "  â€¢ Findomain"
    echo -e "  â€¢ Sublist3r"
    echo -e "  â€¢ crt.sh"
    echo ""
}

# Function to setup API keys
setup_api_keys() {
    echo -e "${BLUE}[*] Setting up API keys configuration...${NC}"
    echo ""
    
    # Create directories
    mkdir -p ~/.config/subfinder
    
    # Subfinder configuration
    echo -e "${YELLOW}[*] Configuring Subfinder API keys...${NC}"
    cat > ~/.config/subfinder/provider-config.yaml << 'EOF'
# Subfinder API Configuration
# Add your API keys below (remove # to enable)

# Free APIs (Highly Recommended)
# virustotal:
#   - YOUR_VIRUSTOTAL_API_KEY

# censys:
#   - YOUR_CENSYS_API_ID:YOUR_CENSYS_SECRET

# github:
#   - YOUR_GITHUB_TOKEN

# chaos:
#   - YOUR_CHAOS_API_KEY

# Paid APIs (Premium Results)
# shodan:
#   - YOUR_SHODAN_API_KEY

# securitytrails:
#   - YOUR_SECURITYTRAILS_API_KEY

# passivetotal:
#   - YOUR_PASSIVETOTAL_USERNAME:YOUR_PASSIVETOTAL_API_KEY

# binaryedge:
#   - YOUR_BINARYEDGE_API_KEY

# bevigil:
#   - YOUR_BEVIGIL_API_KEY

# builtwith:
#   - YOUR_BUILTWITH_API_KEY

# certspotter:
#   - YOUR_CERTSPOTTER_API_KEY

# chinaz:
#   - YOUR_CHINAZ_USERNAME:YOUR_CHINAZ_PASSWORD

# dnsdb:
#   - YOUR_DNSDB_API_KEY

# fofa:
#   - YOUR_FOFA_EMAIL:YOUR_FOFA_KEY

# fullhunt:
#   - YOUR_FULLHUNT_API_KEY

# hunter:
#   - YOUR_HUNTER_API_KEY

# intelx:
#   - YOUR_INTELX_API_KEY:YOUR_INTELX_UUID

# quake:
#   - YOUR_QUAKE_TOKEN

# robtex:
#   - YOUR_ROBTEX_API_KEY

# spyse:
#   - YOUR_SPYSE_API_TOKEN

# threatbook:
#   - YOUR_THREATBOOK_API_KEY

# urlscan:
#   - YOUR_URLSCAN_API_KEY

# whoisxmlapi:
#   - YOUR_WHOISXMLAPI_KEY

# zoomeye:
#   - YOUR_ZOOMEYE_USERNAME:YOUR_ZOOMEYE_PASSWORD
EOF
    
    echo -e "${GREEN}[+] API configuration files created!${NC}"
    echo ""
    echo -e "${YELLOW}NEXT STEPS:${NC}"
    echo -e "${CYAN}1. Edit Subfinder config:${NC} nano ~/.config/subfinder/provider-config.yaml"
    echo -e "${CYAN}2. Remove # and add your API keys${NC}"
    echo -e "${CYAN}3. Run: $0 --check-apis to verify${NC}"
    echo ""
    echo -e "${YELLOW}FREE API KEYS TO GET:${NC}"
    echo -e "${CYAN}â€¢ VirusTotal:${NC} https://www.virustotal.com/gui/join-us"
    echo -e "${CYAN}â€¢ GitHub Token:${NC} https://github.com/settings/tokens"
    echo -e "${CYAN}â€¢ Censys:${NC} https://censys.io/register"
    echo -e "${CYAN}â€¢ Chaos (ProjectDiscovery):${NC} https://chaos.projectdiscovery.io"
    echo ""
}

# Function to check API configuration
check_api_keys() {
    echo -e "${BLUE}[*] Checking API key configuration...${NC}"
    echo ""
    
    # Check Subfinder config
    if [ -f ~/.config/subfinder/provider-config.yaml ]; then
        echo -e "${GREEN}[+] Subfinder config found${NC}"
        active_apis=$(grep -v "^#" ~/.config/subfinder/provider-config.yaml | grep -E "^\s*[a-zA-Z].*:" | wc -l)
        echo -e "${CYAN}   Active APIs: ${active_apis}${NC}"
        
        if [ $active_apis -gt 0 ]; then
            echo -e "${CYAN}   Configured APIs:${NC}"
            grep -v "^#" ~/.config/subfinder/provider-config.yaml | grep -E "^\s*[a-zA-Z].*:" | sed 's/:.*$//' | sed 's/^/     - /'
        fi
    else
        echo -e "${RED}[-] Subfinder config not found${NC}"
        echo -e "${YELLOW}   Run: $0 --setup-apis${NC}"
    fi
    echo ""
}

# Parse command line arguments
THREADS=$DEFAULT_THREADS
DOMAINS_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -t|--threads)
            if [[ -n $2 && $2 =~ ^[0-9]+$ ]]; then
                THREADS=$2
                shift 2
            else
                echo -e "${RED}Error: --threads requires a positive integer${NC}"
                exit 1
            fi
            ;;
        --setup-apis)
            setup_api_keys
            exit 0
            ;;
        --check-apis)
            check_api_keys
            exit 0
            ;;
        --help)
            show_usage
            exit 0
            ;;
        --*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
        *)
            if [[ -z $DOMAINS_FILE ]]; then
                DOMAINS_FILE=$1
                shift
            else
                echo -e "${RED}Error: Multiple domain files specified${NC}"
                show_usage
                exit 1
            fi
            ;;
    esac
done

# Check if domains file argument is provided
if [[ -z $DOMAINS_FILE ]]; then
    show_usage
    exit 1
fi

# Check if domains file exists
if [ ! -f "$DOMAINS_FILE" ]; then
    echo -e "${RED}[-] Domains file not found: $DOMAINS_FILE${NC}"
    exit 1
fi

OUTPUT_DIR="results_$(date +%Y%m%d_%H%M%S)"

# Create output directory
mkdir -p $OUTPUT_DIR
cd $OUTPUT_DIR

echo -e "${GREEN}[+] Starting multi-threaded subdomain enumeration${NC}"
echo -e "${GREEN}[+] Domains file: ${DOMAINS_FILE}${NC}"
echo -e "${GREEN}[+] Threads: ${THREADS}${NC}"
echo -e "${GREEN}[+] Results directory: ${OUTPUT_DIR}${NC}"

# Read domains from file and clean them (remove wildcards)
DOMAINS=()
while IFS= read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^#.*$ ]] && continue
    # Remove wildcard prefix if present
    clean_domain=$(echo "$line" | sed 's/^\*\.//')
    DOMAINS+=("$clean_domain")
done < "../$DOMAINS_FILE"

echo -e "${GREEN}[+] Found ${#DOMAINS[@]} domains to process${NC}"

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check for required tools
echo -e "${BLUE}[*] Checking for available tools...${NC}"

AVAILABLE_TOOLS=()
MISSING_TOOLS=()

REQUIRED_TOOLS=("subfinder" "assetfinder" "findomain" "sublist3r" "crtsh")

for tool in "${REQUIRED_TOOLS[@]}"; do
    if command_exists $tool; then
        AVAILABLE_TOOLS+=("$tool")
        echo -e "${GREEN}[+] ${tool} - Available${NC}"
    else
        MISSING_TOOLS+=("$tool")
        echo -e "${RED}[-] ${tool} - Missing${NC}"
    fi
done

if [ ${#AVAILABLE_TOOLS[@]} -eq 0 ]; then
    echo -e "${RED}[-] No enumeration tools found! Please install tools first.${NC}"
    exit 1
fi

echo -e "${CYAN}[*] Will use ${#AVAILABLE_TOOLS[@]} available tools${NC}"
if [ ${#MISSING_TOOLS[@]} -gt 0 ]; then
    echo -e "${YELLOW}[!] Missing tools: ${MISSING_TOOLS[*]}${NC}"
fi

# Check API configuration status
echo ""
echo -e "${BLUE}[*] Checking API configuration...${NC}"
if [ -f ~/.config/subfinder/provider-config.yaml ]; then
    active_apis=$(grep -v "^#" ~/.config/subfinder/provider-config.yaml | grep -E "^\s*[a-zA-Z].*:" | wc -l)
    if [ $active_apis -gt 0 ]; then
        echo -e "${GREEN}[+] Subfinder APIs configured: ${active_apis} active${NC}"
    else
        echo -e "${YELLOW}[!] No Subfinder APIs configured. Run: $0 --setup-apis${NC}"
    fi
else
    echo -e "${YELLOW}[!] Subfinder not configured. Run: $0 --setup-apis for better results${NC}"
fi

echo ""

# Function to run a single tool for subdomain enumeration
run_tool() {
    local tool=$1
    local domain=$2
    local output_file=$3
    
    case $tool in
        "subfinder")
            if command_exists subfinder; then
                subfinder -d $domain -silent -all > $output_file 2>/dev/null
            fi
            ;;
        "assetfinder")
            if command_exists assetfinder; then
                assetfinder --subs-only $domain > $output_file 2>/dev/null
            fi
            ;;
        "findomain")
            if command_exists findomain; then
                findomain -t $domain -q > $output_file 2>/dev/null
            fi
            ;;
        "sublist3r")
            if command_exists sublist3r; then
                sublist3r -d $domain -o $output_file >/dev/null 2>&1
            fi
            ;;
        "crtsh")
            if command_exists crtsh; then
                crtsh -d $domain > $output_file 2>/dev/null
            fi
            ;;
    esac
}

# Function to run subdomain enumeration for a single domain
enumerate_domain() {
    local domain=$1
    local temp_dir="temp_${domain}"
    
    echo -e "${BLUE}[*] Processing domain: ${domain}${NC}"
    
    # Create temporary directory for this domain
    mkdir -p "$temp_dir"
    cd "$temp_dir"
    
    # Start available tools in parallel
    local pids=()
    for tool in "${AVAILABLE_TOOLS[@]}"; do
        run_tool "$tool" "$domain" "${tool}_temp.txt" &
        pids+=($!)
    done
    
    # Wait for all tools to complete
    for pid in "${pids[@]}"; do
        wait $pid
    done
    
    # Count results per tool and display with enhanced formatting
    echo -e "${PURPLE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${PURPLE}â”‚                 TOOL RESULTS FOR ${domain}                 â”‚${NC}"
    echo -e "${PURPLE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    
    local total_before_dedup=0
    local tool_results=()
    
    for tool in "${AVAILABLE_TOOLS[@]}"; do
        if [ -f "${tool}_temp.txt" ]; then
            # Clean and count valid subdomains for this tool
            local count=$(cat "${tool}_temp.txt" 2>/dev/null | grep -E "^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" | grep -i "$domain" | wc -l)
            if [ $count -gt 0 ]; then
                echo -e "${GREEN}  â”œâ”€ ${tool}: ${count} subdomains${NC}"
                total_before_dedup=$((total_before_dedup + count))
                tool_results+=("${tool}: ${count}")
            else
                echo -e "${YELLOW}  â”œâ”€ ${tool}: 0 subdomains${NC}"
                tool_results+=("${tool}: 0")
            fi
        else
            echo -e "${YELLOW}  â”œâ”€ ${tool}: 0 subdomains (failed)${NC}"
            tool_results+=("${tool}: 0")
        fi
    done
    
    echo -e "${PURPLE}  â””â”€ Total (before dedup): ${total_before_dedup} subdomains${NC}"
    echo ""
    
    # Combine and deduplicate results for this domain
    cat *_temp.txt 2>/dev/null | grep -E "^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" | grep -i "$domain" | sort -u > "../${domain}.txt"
    
    # Count final results for this domain
    local final_count=$(wc -l < "../${domain}.txt" 2>/dev/null || echo "0")
    echo -e "${GREEN}[+] ${domain} FINAL RESULT: ${final_count} unique subdomains${NC}"
    
    if [ $total_before_dedup -gt $final_count ]; then
        local duplicates=$((total_before_dedup - final_count))
        echo -e "${CYAN}[!] Removed ${duplicates} duplicate entries${NC}"
    fi
    
    # Save individual tool results to a summary file
    echo "=== ${domain} Tool Results ===" >> "../tool_summary_${domain}.txt"
    for result in "${tool_results[@]}"; do
        echo "$result" >> "../tool_summary_${domain}.txt"
    done
    echo "Total before dedup: $total_before_dedup" >> "../tool_summary_${domain}.txt"
    echo "Final unique count: $final_count" >> "../tool_summary_${domain}.txt"
    echo "" >> "../tool_summary_${domain}.txt"
    
    # Go back to main directory and clean up
    cd ..
    rm -rf "$temp_dir"
}

# Record start time
START_TIME=$(date +%s)

# Start subdomain enumeration for all domains with threading
echo -e "${BLUE}[*] Starting multi-threaded passive subdomain enumeration...${NC}"
echo -e "${CYAN}[*] Processing ${#DOMAINS[@]} domains with ${THREADS} threads${NC}"
echo ""

# Function to process domains in parallel
process_domains_parallel() {
    local -a domain_pids=()
    local processed=0
    local active_jobs=0
    
    for domain in "${DOMAINS[@]}"; do
        # Wait if we've reached the thread limit
        while [ $active_jobs -ge $THREADS ]; do
            for i in "${!domain_pids[@]}"; do
                if ! kill -0 "${domain_pids[$i]}" 2>/dev/null; then
                    unset domain_pids[$i]
                    active_jobs=$((active_jobs - 1))
                fi
            done
            # Remove empty array elements
            domain_pids=("${domain_pids[@]}")
            sleep 0.1
        done
        
        # Start processing domain in background
        enumerate_domain "$domain" &
        domain_pids+=($!)
        active_jobs=$((active_jobs + 1))
        processed=$((processed + 1))
        
        echo -e "${CYAN}[*] Started domain ${processed}/${#DOMAINS[@]}: ${domain} (Active: ${active_jobs}/${THREADS})${NC}"
    done
    
    # Wait for all remaining processes to complete
    echo -e "${YELLOW}[*] Waiting for all domains to complete...${NC}"
    for pid in "${domain_pids[@]}"; do
        wait $pid
    done
}

# Process all domains
process_domains_parallel

# Record end time
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Combine all domain results into final file
echo -e "${BLUE}[*] Combining all results from all domains...${NC}"

cat *.txt 2>/dev/null | grep -v "^===" | sort -u > all_subdomains.txt

# Count total results
TOTAL_SUBDOMAINS=$(wc -l < all_subdomains.txt 2>/dev/null || echo "0")

echo ""
echo -e "${GREEN}=========================================================="
echo "              ENUMERATION COMPLETED!"
echo "==========================================================${NC}"

# Create and display usage summary
echo -e "${YELLOW}===============================================${NC}"
echo -e "${YELLOW}              USAGE SUMMARY${NC}"
echo -e "${YELLOW}===============================================${NC}"

# Format duration
if [ $DURATION -ge 3600 ]; then
    HOURS=$((DURATION / 3600))
    MINUTES=$(((DURATION % 3600) / 60))
    SECONDS=$((DURATION % 60))
    DURATION_STR="${HOURS}h ${MINUTES}m ${SECONDS}s"
elif [ $DURATION -ge 60 ]; then
    MINUTES=$((DURATION / 60))
    SECONDS=$((DURATION % 60))
    DURATION_STR="${MINUTES}m ${SECONDS}s"
else
    DURATION_STR="${DURATION}s"
fi

echo -e "${CYAN}â±ï¸  Total execution time: ${DURATION_STR}${NC}"
echo -e "${CYAN}ğŸ§µ Threads used: ${THREADS}${NC}"
echo -e "${CYAN}ğŸ¯ Domains processed: ${#DOMAINS[@]}${NC}"
echo -e "${CYAN}ğŸ”§ Tools used: ${#AVAILABLE_TOOLS[@]}/${#REQUIRED_TOOLS[@]} (${AVAILABLE_TOOLS[*]})${NC}"
echo -e "${CYAN}ğŸ“Š Total unique subdomains: ${TOTAL_SUBDOMAINS}${NC}"

# Calculate average processing time per domain
if [ ${#DOMAINS[@]} -gt 0 ]; then
    AVG_TIME_PER_DOMAIN=$((DURATION / ${#DOMAINS[@]}))
    echo -e "${CYAN}âš¡ Average time per domain: ${AVG_TIME_PER_DOMAIN}s${NC}"
fi

# Calculate efficiency (subdomains per second)
if [ $DURATION -gt 0 ]; then
    SUBDOMAINS_PER_SEC=$((TOTAL_SUBDOMAINS / DURATION))
    echo -e "${CYAN}ğŸš€ Subdomains found per second: ${SUBDOMAINS_PER_SEC}${NC}"
fi

echo ""

echo -e "${YELLOW}PER DOMAIN BREAKDOWN:${NC}"
echo -e "${PURPLE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${PURPLE}â”‚              DOMAIN RESULTS SUMMARY                 â”‚${NC}"
echo -e "${PURPLE}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"

for domain in "${DOMAINS[@]}"; do
    if [ -f "${domain}.txt" ]; then
        count=$(wc -l < "${domain}.txt")
        printf "${PURPLE}â”‚${NC} %-25s ${GREEN}%10s subdomains${NC} ${PURPLE}â”‚${NC}\n" "$domain:" "$count"
    fi
done

echo -e "${PURPLE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

# Create comprehensive summary file
echo "===============================================" > final_summary.txt
echo "       SUBDOMAIN ENUMERATION SUMMARY" >> final_summary.txt
echo "===============================================" >> final_summary.txt
echo "Date: $(date)" >> final_summary.txt
echo "Execution time: ${DURATION_STR}" >> final_summary.txt
echo "Threads used: ${THREADS}" >> final_summary.txt
echo "Domains processed: ${#DOMAINS[@]}" >> final_summary.txt
echo "Tools used: ${AVAILABLE_TOOLS[*]}" >> final_summary.txt
echo "Total unique subdomains: ${TOTAL_SUBDOMAINS}" >> final_summary.txt
if [ ${#DOMAINS[@]} -gt 0 ]; then
    echo "Average time per domain: ${AVG_TIME_PER_DOMAIN}s" >> final_summary.txt
fi
if [ $DURATION -gt 0 ]; then
    echo "Subdomains per second: ${SUBDOMAINS_PER_SEC}" >> final_summary.txt
fi
echo "" >> final_summary.txt

# Add per-domain results to summary
for domain in "${DOMAINS[@]}"; do
    echo "" >> final_summary.txt
    echo "=== $domain ===" >> final_summary.txt
    if [ -f "tool_summary_${domain}.txt" ]; then
        cat "tool_summary_${domain}.txt" >> final_summary.txt
    fi
done

echo -e "${CYAN}ğŸ“ Results saved in directory: ${OUTPUT_DIR}${NC}"
echo -e "${CYAN}ğŸ“„ Individual domain files: [domain].txt${NC}"
echo -e "${CYAN}ğŸ“‹ Tool summaries: tool_summary_[domain].txt${NC}"
echo -e "${CYAN}ğŸ“‘ All subdomains: all_subdomains.txt${NC}"
echo -e "${CYAN}ğŸ“Š Final summary: final_summary.txt${NC}"

echo ""

if [ ${#MISSING_TOOLS[@]} -gt 0 ]; then
    echo -e "${YELLOW}[!] Missing tools that could improve results: ${MISSING_TOOLS[*]}${NC}"
fi

echo -e "${BLUE}ğŸ’¡ TIP: For better results, configure API keys with: $0 --setup-apis${NC}"
echo -e "${BLUE}ğŸ“Š Check final_summary.txt for detailed per-tool breakdown${NC}"